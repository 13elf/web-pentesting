#!/usr/bin/python3

import requests
import sys
import os
import os.path
from os import path
import threading
import time

try:
    input_file = sys.argv[1]
except:
    print("Too few arguments. Exitting!")
    exit(0)

try:
    expected_count = int(sys.argv[2])
except:
    expected_count = 20

if(path.exists('results')):
    pass
else:
    os.system("mkdir results || echo '' ")
os.system("touch ./results/validated-domains.txt")
os.system("echo -n '' > ./results/validated-domains.txt")

def write_file(filename, content):
    with open(filename,"a") as f:
        f.write(str(content) + "\n")

def validate_thread(url):
    if len(url) == 0:
        return
    try:
        res = requests.get("http://{0}".format(str(url)), timeout=7)
    except requests.exceptions.ConnectionError:
        try:
            res = requests.get("https://{0}".format(str(url)),timeout=7)
        except requests.exceptions.ConnectionError:
            return
    if res.status_code == 200:
        print("Validated:", url)
        write_file("./results/validated-domains.txt", url)

with open(input_file, "r") as f:
    content = f.read()
    array = content.split('\n')

for i in array:
    if threading.active_count() <= expected_count:
        threading.Thread(target=validate_thread, args=(i,)).start()
    else:
        print("DEBUG: expected count variable exceeded the threshold")
        time.sleep(1)
